version: v1.0
name: Docker
agent:
  machine:
    type: e1-standard-2
    os_image: ubuntu2004
blocks:
  - name: Unit Tests
    task:
      jobs:
        - name: Run Unit Tests
          commands:
            - checkout
            - docker image build --tag juliocesarmidia/go-orm-api-test:latest -f test.Dockerfile .
            - docker container run --rm --name go-orm-api-test juliocesarmidia/go-orm-api-test:latest
  - name: Build and Push
    task:
      jobs:
        - name: Run Build and Push Image
          commands:
            - checkout
            - SHORT_SHA=$(echo "$SEMAPHORE_GIT_SHA" | cut -c1-7)
            - echo "$GITHUB_TOKEN" | docker login ghcr.io -u "$GITHUB_USERNAME" --password-stdin
            - docker image build --tag "juliocesarmidia/go-orm-api:$SHORT_SHA" -f Dockerfile --cache-from=juliocesarmidia/go-orm-api-test:latest .
            - docker image tag "juliocesarmidia/go-orm-api:$SHORT_SHA" "ghcr.io/$GITHUB_USERNAME/go-orm-api:$SHORT_SHA"
            - docker image push "ghcr.io/$GITHUB_USERNAME/go-orm-api:$SHORT_SHA"
      secrets:
        - name: docker-hub
