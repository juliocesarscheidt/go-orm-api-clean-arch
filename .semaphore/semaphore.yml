version: v1.0
name: PipelineCI
agent:
  machine:
    type: e1-standard-2
    os_image: ubuntu2004
blocks:
  - name: Unit_Tests
    task:
      jobs:
        - name: Run_Unit_Tests
          commands:
            - checkout
            - docker image build --tag juliocesarmidia/go-orm-api-test:latest -f test.Dockerfile .
            - docker container run --rm --name go-orm-api-test juliocesarmidia/go-orm-api-test:latest
  - name: Build_Image_and_Check_Vulnerabilities
    task:
      jobs:
        - name: Run_Build_Image
          commands:
            - checkout
            - docker image build --tag "juliocesarmidia/go-orm-api:latest" -f Dockerfile --cache-from=juliocesarmidia/go-orm-api-test:latest .
        - name: Run_Check_Vulnerabilities_on_Image
          dependencies: ["Run_Build_Image"]
          commands:
            - checkout
            - wget https://github.com/aquasecurity/trivy/releases/download/v0.37.1/trivy_0.37.1_Linux-64bit.deb
            - sudo dpkg -i trivy_0.37.1_Linux-64bit.deb
            - trivy image --exit-code 1 --severity CRITICAL --quiet --light "juliocesarmidia/go-orm-api:latest"
  - name: Push_Image
    task:
      jobs:
        - name: Run_Push_Image
          commands:
            - checkout
            - SHORT_SHA=$(echo "$SEMAPHORE_GIT_SHA" | cut -c1-7)
            - docker image build --tag "ghcr.io/$GITHUB_USERNAME/go-orm-api:$SHORT_SHA" -f Dockerfile --cache-from=juliocesarmidia/go-orm-api-test:latest .
            - echo "$GITHUB_TOKEN" | docker login ghcr.io -u "$GITHUB_USERNAME" --password-stdin
            - docker image push "ghcr.io/$GITHUB_USERNAME/go-orm-api:$SHORT_SHA"
      secrets:
        - name: docker-hub
